<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Update Section</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Custom styles for the toggle switch */
      body {
        font-family: "Inter", sans-serif;
      }
      .toggle-checkbox:checked {
        right: 0;
        border-color: #4f46e5; /* indigo-600 */
      }
      .toggle-checkbox:checked + .toggle-label {
        background-color: #4f46e5; /* indigo-600 */
      }
    </style>
  </head>

  <body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div
      class="w-full max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-8 md:p-10"
    >
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl md:text-3xl font-bold text-gray-800">
          Update Section
        </h1>
        <button
          id="backButton"
          class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300"
        >
          Quay láº¡i
        </button>
      </div>

      <form id="updateSectionForm" novalidate>
        <div class="space-y-6">
          <div>
            <label
              for="deviceName"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Device Name</label
            >
            <input
              type="text"
              id="deviceName"
              name="deviceName"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200"
              placeholder="e.g., Introduction to JavaScript"
            />
          </div>

          <div>
            <label
              for="deviceDescription"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Device Description</label
            >
            <textarea
              id="deviceDescription"
              name="deviceDescription"
              rows="4"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200"
              placeholder="Describe the device's content..."
            ></textarea>
          </div>

          <div>
            <label
              for="cost"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Cost</label
            >
            <input
              type="number"
              min="0"
              max="999999"
              id="cost"
              name="cost"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200"
              placeholder="e.g., 2 hours 30 minutes"
            />
          </div>
          <div>
            <label
              for="saleOff"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Sale Off</label
            >
            <input
              type="number"
              min="0"
              max="1"
              id="saleOff"
              name="saleOff"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200"
              placeholder="e.g., 2 hours 30 minutes"
            />
          </div>

          <div>
            <label
              for="models"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Models</label
            >
            <select
              id="models"
              name="models"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200 bg-white"
            >
              <option value="" disabled selected>Loading models...</option>
            </select>
          </div>

          <div class="flex items-center justify-between">
            <span class="text-sm font-medium text-gray-700"
              >Is this a Famous Device?</span
            >
            <div
              class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in"
            >
              <input
                type="checkbox"
                name="isFamous"
                id="isFamous"
                class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"
              />
              <label
                for="isFamous"
                class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"
              ></label>
            </div>
          </div>
        </div>

        <div id="message-container" class="mt-6 text-sm"></div>
        <div class="mt-8">
          <button
            type="submit"
            id="submit-button"
            class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-300 shadow-lg disabled:bg-indigo-300 disabled:cursor-not-allowed"
          >
            Update Device
          </button>
        </div>
      </form>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("updateSectionForm");
        const modelSelect = document.getElementById("models");
        const submitButton = document.getElementById("submit-button");
        const messageContainer = document.getElementById("message-container");
        const API_BASE_URL = "http://localhost:3000/api";
        const token = localStorage.getItem("access_token");
        // Get device ID from the URL
        const pathParts = window.location.pathname.split("/");
        const deviceId = pathParts[pathParts.length - 1];

        const showMessage = (text, type = "error") => {
          messageContainer.innerHTML = `
            <div class="p-4 rounded-md ${
              type === "error"
                ? "bg-red-100 text-red-700"
                : "bg-green-100 text-green-700"
            }">
              ${text}
            </div>
          `;
        };

        const clearMessage = () => {
          messageContainer.innerHTML = "";
        };

        document.getElementById("backButton").addEventListener("click", () => {
          window.location.href = "/view/sections";
        });

        const fetchModels = async (currentModelId) => {
          try {
            const response = await axios.get(`${API_BASE_URL}/models`, {
              headers: { Authorization: `Bearer ${token}` },
            });
            const models = response.data.data || response.data;
            console.log("Fetched models:", models);
            if (Array.isArray(models) && models.length > 0) {
              modelSelect.innerHTML = "";
              models.forEach((model) => {
                const option = document.createElement("option");
                option.value = model._id;
                option.textContent =
                  model.modelName || `Model ID: ${model._id}`;
                if (model._id === currentModelId) {
                  option.selected = true;
                }
                modelSelect.appendChild(option);
              });
            } else {
              modelSelect.innerHTML =
                '<option value="" disabled selected>No models found</option>';
            }
          } catch (error) {
            console.error("Error fetching models:", error);
            showMessage("Failed to fetch models.", "error");
            modelSelect.innerHTML =
              '<option value="" disabled selected>Error loading models</option>';
          }
        };

        const loadDeviceData = async () => {
          if (!token) {
            showMessage("Authentication token not found. Please log in.");
            submitButton.disabled = true;
            return;
          }
          if (!deviceId) {
            showMessage("Device ID not found in URL.");
            submitButton.disabled = true;
            return;
          }
          try {
            const response = await axios.get(
              `${API_BASE_URL}/devices/${deviceId}`,
              {
                headers: { Authorization: `Bearer ${token}` },
              }
            );

            const device = response.data.data || response.data;
            console.log(device);
            document.getElementById("deviceName").value = device.deviceName;
            document.getElementById("deviceDescription").value =
              device.deviceDescription;
            document.getElementById("cost").value = device.cost;
            document.getElementById("saleOff").value = device.saleOff;
            document.getElementById("isFamous").checked = device.famouse;

            await fetchModels(device.model);
          } catch (error) {
            console.error("Error fetching device data:", error);
            const errorMessage =
              error.response?.data?.message || "Failed to load device data.";
            showMessage(errorMessage, "error");
            submitButton.disabled = true;
          }
        };

        form.addEventListener("submit", async (event) => {
          event.preventDefault();
          clearMessage();

          if (!token) {
            showMessage(
              "Authentication token not found. Cannot update section."
            );
            return;
          }
          const formData = new FormData(form);
          const data = {
            deviceName: formData.get("deviceName"),
            deviceDescription: formData.get("deviceDescription"),
            saleOff: formData.get("saleOff"),
            cost: formData.get("cost"),
            models: formData.get("models"),
            isFamous: document.getElementById("isFamous").checked,
          };
          if (
            !data.deviceName ||
            !data.deviceDescription ||
            !data.saleOff ||
            !data.cost ||
            !data.models
          ) {
            showMessage("Please fill out all required fields.");
            return;
          }
          submitButton.disabled = true;
          submitButton.textContent = "Updating...";
          try {
            await axios.put(`${API_BASE_URL}/devices/${deviceId}`, data, {
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
            });
            showMessage("Device updated successfully!", "success");
            setTimeout(() => {
              window.location.href = "/devices";
            }, 1500);
          } catch (error) {
            console.error("Error updating device:", error);
            const errorMessage =
              error.response?.data?.message || "An unknown error occurred.";
            showMessage(`Error: ${errorMessage}`);
          } finally {
            submitButton.disabled = false;
            submitButton.textContent = "Update Device";
          }
        });

        // Initial data load
        loadDeviceData();
      });
    </script>
  </body>
</html>
